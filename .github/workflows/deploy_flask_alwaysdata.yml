name: Deploy Flask app to AlwaysData

on:
  push:
    branches:
      - 0.0.12   # déclenche automatiquement quand il y a un push sur cette branche

  workflow_dispatch:   # permet de lancer manuellement et de choisir la branche
    inputs:
      branch:
        description: 'Nom de la branche à déployer'
        required: true
        default: '0.0.12'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AD_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.AD_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/id_ed25519 -o BatchMode=yes ${{ secrets.AD_USER }}@${{ secrets.AD_HOST }} "echo 'SSH connection OK'" || exit 1

      - name: Determine branch to deploy
        run: |
          # Détecte si on est en workflow_dispatch ou push
          if [ -n "${{ github.event.inputs.branch }}" ]; then
            BRANCH_TO_DEPLOY="${{ github.event.inputs.branch }}"
          else
            BRANCH_TO_DEPLOY="${GITHUB_REF##refs/heads/}"
          fi
          echo "Branch to deploy: $BRANCH_TO_DEPLOY"
          echo "BRANCH_TO_DEPLOY=$BRANCH_TO_DEPLOY" >> $GITHUB_ENV

      - name: Update code on AlwaysData
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.AD_USER }}@${{ secrets.AD_HOST }} "
            set -e  # arrêter en cas d'erreur
            cd /home/inventory-service/inventory_service || { echo 'Dossier /home/inventory-service/inventory_service introuvable'; exit 1; }
            git fetch origin
            git checkout $BRANCH_TO_DEPLOY || { echo 'Impossible de checkout la branche'; exit 1; }
            git pull origin $BRANCH_TO_DEPLOY || { echo 'Impossible de faire git pull'; exit 1; }
          "

      - name: Install Python dependencies
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.AD_USER }}@${{ secrets.AD_HOST }} "
            cd /home/inventory-service/inventory_service/backend
            python3 -m pip install --upgrade pip
            pip install -r requirements.txt
          "
